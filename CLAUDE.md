# Lattice - Swift ORM with Sync

## Overview
Lattice is a Swift-based Object-Relational Mapping (ORM) library built on SQLite with built-in sync capabilities. It uses Swift macros for compile-time code generation and provides a Realm-like API.

## Project Structure

```
Lattice/
├── Sources/
│   ├── Lattice/              # Core ORM implementation
│   ├── LatticeMacros/        # Swift macro implementations (@Model, @Property, etc.)
│   └── LatticeServerKit/     # Server-side sync infrastructure
├── Tests/
│   └── LatticeTests/         # Unit tests
└── realm-cpp/                # Reference implementation (cloned for C++ SDK research)
```

## Key Architecture Decisions

### 1. **Struct-Based Design (Not Actor)**
- `Lattice` is a **struct**, not an actor
- Wraps a shared `SharedDBPointer` that manages SQLite connection
- Isolation tracking is for **notification delivery**, not execution context
- Multiple `Lattice` instances can share the same underlying database via `latticeIsolationRegistrar`

### 2. **Macro-Based Property System**
- `@Model` macro generates schema metadata and property accessors
- `@Property` macro creates `Accessor<T>` wrappers for change tracking
- Properties are accessed via `Accessor` which intercepts reads/writes
- All macros in `Sources/LatticeMacros/LatticeMacros.swift`

### 3. **Automatic Schema Discovery**
- New feature: `discoverAllTypes(from:)` recursively finds linked Model types
- Uses breadth-first search with cycle detection
- Eliminates need to manually specify all types in schema
- See `Lattice.swift:684-715`

### 4. **Reserved Property Names**
- `id` and `globalId` are reserved (auto-generated by Lattice)
- Macro validation prevents users from using these names
- Diagnostic shows line number for better DX
- See `LatticeMacros.swift:366-378`

### 5. **Change Tracking & Sync**
- `AuditLog` table tracks all mutations (inserts, updates, deletes)
- Each change records: table name, operation, row ID, changed fields
- `globalRowId` (UUID) enables cross-device sync
- Sync system in `Sync.swift`, server in `LatticeServerKit`

## Current State

### Completed Features
- ✅ Basic CRUD operations
- ✅ Query DSL with type-safe predicates
- ✅ Relationships (links, link lists)
- ✅ Embedded models
- ✅ Observable results
- ✅ Automatic schema discovery
- ✅ Reserved name validation with diagnostics
- ✅ Private(set) property support
- ✅ @Codable macro for JSON export

### Pending Work (See Todos)
- ⏳ AuditLog compaction (reduce sync payload size)
- ⏳ Accessor init for non-optional EmbeddedModel/LatticeEnum
- ⏳ Type inference from default values in PropertyMacro
- ⏳ LatticeCpp SDK design (macro-based, similar to realm-cpp)

## Future Vision

### Cross-Platform Strategy
```
┌─────────────────────────────────────────────────┐
│           Platform Layer (UI)                   │
│  SwiftUI (iOS/macOS)    Jetpack Compose (Android)│
└─────────────────────────────────────────────────┘
                      │
┌─────────────────────────────────────────────────┐
│         Language Binding Layer                  │
│   LatticeSwift          LatticeKotlin           │
└─────────────────────────────────────────────────┘
                      │
┌─────────────────────────────────────────────────┐
│           Core C++ Layer                        │
│   LatticeCpp (ORM with macro-based models)      │
└─────────────────────────────────────────────────┘
```

### LatticeCpp Design (Inspired by realm-cpp)
- Macro-based schema registration: `LATTICE_SCHEMA(Trip, name, days, destinations)`
- `managed<T>` wrappers for property access with change tracking
- Scheduler injection for cross-platform concurrency (Swift actors, Kotlin dispatchers)
- SQLite as storage backend
- Reference: `/Users/jason/Documents/realm-cpp/`

## Testing

Run tests:
```bash
swift test                              # All tests
swift test --filter test_BasicSync      # Specific test
```

### Test Utilities
- `testLattice(path:types...)` - Creates temporary database with fresh schema
- Always use temporary DB in tests to avoid schema conflicts
- Example: `PropertyTests.swift:22-40`

## Important Notes

### Database Schema
- Tables auto-created in `Lattice.init` (see `Lattice.swift:337-346`)
- Every table gets `id INTEGER PRIMARY KEY` and `globalId TEXT UNIQUE`
- Foreign keys enabled via `PRAGMA foreign_keys = ON`
- WAL mode for concurrent access

### Isolation & Threading
- Isolation captured via `isolated (any Actor)? = #isolation` parameter
- Used for dispatching observer notifications to correct context
- Future: May move to `Configuration` struct instead of init parameter
- Similar to Realm's scheduler injection pattern

### Sync Protocol
- Client-side: `AuditLog` tracks changes, uploads via `Synchronizer`
- Server-side: `LatticeServerKit` receives changes, broadcasts to other clients
- Conflict resolution: Last-write-wins (timestamp-based)
- TODO: Implement compaction to reduce payload size

## Related Projects

### JoyJetKit
- Travel planning app using Lattice
- Located at `/Users/jason/Documents/JoyJetPkg/JoyJetKit/`
- Complex model hierarchy (Trip → Destination → Segment → Day → Activity)
- Uses `TripOrchestrator` actor for business logic
- Future: Extract to JoyJetCpp core with Swift/Kotlin wrappers

## Common Patterns

### Defining a Model
```swift
@Model
@Codable  // Optional: enables JSON export
public class Trip {
    public var name: String
    public var days: Int
    public var destinations: List<Destination>

    init(name: String, days: Int) {
        self.name = name
        self.days = days
    }
}
```

### Using Lattice
```swift
let lattice = try Lattice(Trip.self, Destination.self)  // Or just Trip.self (auto-discovers links)

let trip = Trip(name: "Costa Rica", days: 10)
lattice.add(trip)

let trips = lattice.objects(Trip.self)
for trip in trips {
    print(trip.name)
}
```

### Observing Changes
```swift
let results = lattice.objects(Trip.self)
results.observe { trips in
    // Called on specified isolation (e.g., MainActor)
    updateUI(trips)
}
```

## Git Status (Session Start)
```
Current branch: main
Modified files:
- Sources/Lattice/Cursor.swift (Added)
- Sources/Lattice/DatabaseConnection.swift
- Sources/Lattice/Lattice.swift (Added schema discovery)
- Sources/LatticeMacros/LatticeMacros.swift (Added reserved name validation)
- Tests/LatticeTests/PropertyTests.swift (Fixed test to use testLattice)
```
